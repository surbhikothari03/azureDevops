trigger:
- main  # Change to your actual branch name if different

pool:
  vmImage: ubuntu-latest

variables:
  acrLoginServer: azuredevops.azurecr.io

steps:

# Upload the deploy-container.sh to remote Linux VM
- task: CopyFilesOverSSH@0
  displayName: 'Upload deploy-container.sh to Linux VM'
  inputs:
    sshEndpoint: 'lba-vm'  # Replace with your SSH service connection name
    sourceFolder: '$(Build.SourcesDirectory)/scripts'
    contents: 'deploy-container.sh'
    targetFolder: '/home/azureuser/scripts'  # Adjust if username or path is different

# Execute the script remotely with ACR credentials passed as environment variables
- task: SSH@0
  displayName: 'Run deployment script on Linux VM'
  inputs:
    sshEndpoint: 'lba-vm'
    runOptions: 'commands'
    commands: |
      echo "Running deployment script on remote VM..."
      export acrUsername="$(acrUsername)"
      export acrPassword="$(acrPassword)"
      chmod +x /home/azureuser/scripts/deploy-container.sh
      /home/azureuser/scripts/deploy-container.sh
  env:
    acrUsername: $(acrUsername)
    acrPassword: $(acrPassword)
