trigger:
- main

variables:
  imageName: 'azuredevops'
  dockerfilePath: Dockerfile
  acrLoginServer: 'azuredevops.azurecr.io'
  acrUsername: 'azuredevops'
  # acrPassword is stored as a **secret variable** in the pipeline UI or Variable Group

pool:
  name: Default

stages:
- stage: BuildAndPush
  jobs:
  - job: Build
    steps:
    - script: |
        echo "ACR Login Server: $(acrLoginServer)"
        echo "Trying to log in to ACR..."
        echo $(acrPassword) | docker login $(acrLoginServer) -u $(acrUsername) --password-stdin
        displayName: 'Docker Login to ACR'

        echo "Building Docker image..."
        docker build -t $(acrLoginServer)/$(imageName):latest -f $(dockerfilePath) .

        echo "Pushing Docker image to ACR..."
        docker push $(acrLoginServer)/$(imageName):latest
      displayName: 'Build and Push using docker CLI'

- stage: Deploy
  dependsOn: BuildAndPush
  jobs:
  - job: DeployToVM
    steps:
    - task: SSH@0
      displayName: 'Deploy on Azure VM'
      inputs:
        sshEndpoint: 'lba-vm'
        runOptions: 'inline'
        inline: |
          echo "Logging in to ACR..."
          echo $(acrPassword) | docker login $(acrLoginServer) -u $(acrUsername) --password-stdin

          echo "Pulling image from ACR..."
          docker pull $(acrLoginServer)/$(imageName):latest

          echo "Stopping old container (if any)..."
          docker stop nodejs-container || true
          docker rm nodejs-container || true

          echo "Starting new container..."
          docker run -d --name nodejs-container -p 3000:3000 $(acrLoginServer)/$(imageName):latest
