trigger:
- main

variables:
  imageName: 'azuredevops'
  dockerfilePath: Dockerfile
  acrLoginServer: 'azuredevops.azurecr.io'
  acrUsername: 'azuredevops'  # ACR admin username
  # acrPassword is securely stored in Azure DevOps pipeline variables

pool:
  name: Default

stages:
# Stage 1: Build & Push Docker image to ACR
- stage: BuildAndPush
  jobs:
  - job: Build
    steps:
    - script: |
        echo "Logging in to ACR..."
        echo "$ACR_PASSWORD" | docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME" --password-stdin

        echo "Building Docker image..."
        docker build -t "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest" -f "$DOCKERFILE_PATH" .

        echo "Pushing Docker image to ACR..."
        docker push "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest"
      env:
        ACR_LOGIN_SERVER: $(acrLoginServer)
        ACR_USERNAME: $(acrUsername)
        ACR_PASSWORD: $(acrPassword)
        IMAGE_NAME: $(imageName)
        DOCKERFILE_PATH: $(dockerfilePath)
      displayName: 'Build and Push Docker Image'

# Stage 2: Deploy to Azure VM via SSH
- stage: Deploy
  dependsOn: BuildAndPush
  jobs:
  - job: DeployToVM
    steps:
    - task: SSH@0
      displayName: 'Deploy on Azure VM'
      inputs:
        sshEndpoint: 'lba-vm'  # Replace with your actual SSH service connection name
        runOptions: 'inline'
        inline: |
          echo "Logging in to ACR..."
          docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME" -p "$ACR_PASSWORD"

          echo "Pulling image from ACR..."
          docker pull "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest"

          echo "Stopping old container if exists..."
          docker stop nodejs-container 2>/dev/null || true
          docker rm nodejs-container 2>/dev/null || true

          echo "Starting new container..."
          docker run -d --name nodejs-container -p 3000:3000 "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest"

          echo "âœ… Deployment complete!"
      env:
        ACR_USERNAME: $(acrUsername)
        ACR_PASSWORD: $(acrPassword)
        ACR_LOGIN_SERVER: $(acrLoginServer)
        IMAGE_NAME: $(imageName)
